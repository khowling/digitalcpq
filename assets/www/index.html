<!DOCTYPE html>
<html lang="en" ng-app="myApp" class="no-js">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>My AngularJS App</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="bower_components/foundation/css/normalize.css"/>
    <link rel="stylesheet" href="bower_components/foundation/css/foundation.css"/>
    <link rel="stylesheet" href="bower_components/foundation-icon-fonts/foundation-icons.css" />

    <link rel="stylesheet" href="css/style.css"/>
    <script src="bower_components/foundation/js/vendor/modernizr.js"></script>

	 	<script	src="cordova-2.3.0.js" type="text/javascript"></script>
	 	<script	src="cordova.force.js" type="text/javascript"></script>
</head>
<body ng-controller="homeCtrl">

<!-- 
<div class="off-canvas-wrap" data-offcanvas>

    <div class="fixed off-canvas-fixed">

        
        <div class=" fixed show-for-medium-down">
            <nav class="tab-bar " style="background: white; border-bottom: 1px solid #dbdbdb;">

                <section class="left-small" style="border-right: 0px;">
                    <a class="left-off-canvas-toggle" ><i class="fi-list" style="font-size: 25px; margin: 10px;"></i></a>
                </section>

                <section class="middle tab-bar-section" style="right: 15rem;">

										<div style="white-space: nowrap; height: 45px;">
										<div style="display: inline-block!important; vertical-align: top;" >
										   <a href="#" class="hide-for-small" style="margin-right: 20px;">
										            <img src="http://www.mindatrest.co.uk/images/cirrusglobe.png" style="height: 30px;"/>
										    	<strong>Digital</strong></a>
												
										</div>

											<div style="display: inline-block!important; margin-top: 5px;" class="switch1 round">
											  <input id="exampleCheckboxSwitch" type="checkbox" ng-model="online">
											  <label for="exampleCheckboxSwitch"></label>
											</div>
											
											<h5 class="subheading" style="display: inline-block;  vertical-align: top; color: black;" ng-bind="mode"></h5>
											
											<a style="display: inline-block;  margin-top: 5px; margin-bottom: 0px; vertical-align: top;" class="button tiny round" ng-class="{'success': syncinfo.tosync > 0 && syncinfo.errcount == 0, 'alert': syncinfo.errcount >0 }" ng-href="#/customer?sync"> <strong>Sync <span ng-show="syncinfo.tosync > 0" >[{{syncinfo.tosync}}]</span></strong></strong></a>
											
										</div>
                </section>


                <section class="right tab-bar-section" style="left: auto; border-left: 0px;">
                    <a ng-href="#basket" class=" button radius" style="padding: 5px 20px;">
                        {{selectedCustomer.FirstName}} {{selectedCustomer.LastName}}<i class="fi-shopping-cart" style="font-size: 18px;margin-left: 5px; margin-right: 5px;"></i><i class="fi-pound" style="font-size: 10px; margin: 2px;"></i><span ng-bind="selectedBasket.total"/> (<span ng-bind="selectedBasket.items">)</span>
                    </a>
                </section>

            </nav>
        </div>

      
        <aside class="left-off-canvas-menu">
            <ul class="off-canvas-list" >
                <li><label>Digital Quote</label></li>
                <li><a class="left-off-canvas-toggle" ng-href="#/">Home</a></li>
                <li><a class="left-off-canvas-toggle" ng-href="#/customer">Select Customer</a></li>
                <li><a class="left-off-canvas-toggle" ng-href="#/search">Product Search</a></li>
                <li><a class="left-off-canvas-toggle" ng-href="#/basket">Show Basket</a></li>
                <li><a class="left-off-canvas-toggle" ng-href="#/packages">Top Offers</a></li>
                <li><hr/><a class="left-off-canvas-toggle" ng-href="#/customer?sync">Sync</a></li>
                
            </ul>
        </aside>
    </div>

    <div class="inner-wrap">
    
    -->

        <!-- top nav for medium large only 
        <nav class="tab-bar hide-for-medium-down" data-topbar="" style="background: white; border-bottom: 1px solid #dbdbdb;">


            <section class="middle tab-bar-section">
                <h6><a href="#">
                    <img src="http://www.mindatrest.co.uk/images/cirrusglobe.png" style="height: 30px;"/>
                    <a href="#">Digital</a>
                </h6>
            </section>
            
            <section class="right tab-bar-section" style="left: auto;">
							<div class="row collapse">
								<div class="large-6 small-6 columns">
									<h5 class="subheading" style="color: black;" ng-bind="mode"/>
								</div>
								<div class="large-6 small-6 columns">
									<div class="switch1" style="margin-top: 5px;">
									  <input id="exampleCheckboxSwitch" type="checkbox" ng-model="online">
									  <label for="exampleCheckboxSwitch"></label>
									</div>
								</div>
							</div>
            </section>

        </nav>
				-->
		<div class="fixed">
				<nav class="tab-bar" style="background: white; " data-topbar="1"> <!--  border-bottom: 1px solid #dbdbdb; -->

                <section class="left-small" style="border-right: 0px;">

                    <a class="show-for-small" ng-href="#/">
                    	<img src="img/sse-images/vodafone.png" style="margin-left: 5px;"/>
                   	</a>
                     
                    <div class="hide-for-small" style="height:100%; width:100%; background: white!important;" >
                    <!-- 
                    	<a href="#"  style="margin-left: 5px;">
											      <img src="img/sse-images/vodafone.png1" style="height: 30px;"/>
											  
											   </a>
											   -->
											</div>
											
											
                </section>

                <section class="middle tab-bar-section" style="padding-left: 0px; right: 15rem;">

										<div style="white-space: nowrap; height: 45px;">
										
											<div style="display: inline-block!important; vertical-align: top;" >
											   <a href="#/" class="hide-for-small" style="margin-right: 20px;">
											    	<img class="logoHead" src="img/sse-images/vod-logo.png"/>
											   </a>
											</div>
	
												<div style="display: inline-block!important; vertical-align: top; line-height: 1.8;">
													<h4 class="hide-for-small" style="font-size: 22px;" ng-bind="mode"></h4>
												</div>
												
												<div style="display: inline-block!important; margin-top: 5px;" class="switch1 round">
												  <input id="exampleCheckboxSwitch" type="checkbox" ng-model="homeonline">
												  <label for="exampleCheckboxSwitch"></label>
												</div>
												
												
												
												<div style="display: inline-block; vertical-align: top;" >
													<a  style="margin-top: 4px; margin-bottom: 0px; vertical-align: top;" class=" button tiny radius" ng-class="{'disabled': !homeonline, 'success': homeonline && syncinfo.tosync > 0 && syncinfo.errcount == 0, 'alert': homeonline && syncinfo.errcount >0 }" ng-href="#/customer?sync"> <strong>Sync <span ng-show="syncinfo.tosync > 0" >[{{syncinfo.tosync}}]</span></strong></strong></a>
												</div>
										</div>
                </section>

                <section class="right tab-bar-section show-for-medium-down cartWrap" style="left: auto; border-left: 0px;">
                    <a ng-href="#basket" class=" button radius headBtn" style="padding: 5px 20px; margin-bottom: 0px; color: black;">
                        {{selectedCustomer.FirstName}} {{selectedCustomer.LastName}}
                        <i class="fi-shopping-cart" style="font-size: 18px;margin-left: 5px; margin-right: 5px;"></i>
                        <i class="fi-pound" style="font-size: 10px; margin: 2px;"></i>
                        <span class="mun" ng-bind="selectedBasket.total"/> (<span ng-bind="selectedBasket.items">)</span>
                    </a>
                </section>

            </nav>
				
				</div>
				
        <div style="height: 55px;"></div>

        <!------------------- The Model when adding things to a cart ------------------------>
        <style> .firstModal:before {
            content: "";
            border: inset 6px;
            border-color: transparent transparent #fff transparent;
            border-bottom-style: solid;
            position: absolute;
            top: -12px;
            left: 90%;
            z-index: 99;
        }</style>

        <div id="itemadded_modal" class="firstModal reveal-modal tiny" data-reveal style="left: 50%;  width: 45%;  top: 50px; min-height: 270px;">
            <p>Your Item has been added to the Shopping Cart</p>
            <hr/>
            <a class="button expand" href="#/search" onclick="jQuery('#itemadded_modal').foundation('reveal', 'close');">continue shopping</a>
            <a class="button expand" href="#/basket" onclick="jQuery('#itemadded_modal').foundation('reveal', 'close');">Checkout</a>
        </div>

        <div id="orderconf_modal" class="firstModal reveal-modal tiny" data-reveal style="left: 50%;  width: 45%;  top: 50px; min-height: 270px;">
            <p>Thank you for your Order, you will receive a confirmation email shortly with delivery details</p>
            <hr/>
            <a class="button expand" href="#/" onclick="jQuery('#orderconf_modal').foundation('reveal', 'close');">Continue</a>
        </div>        
        
				<!------------------------------- Main Page ---------------------------->
        <div class="row ">
						
            <!-- LEFT THIRD -->
            <div class="hide-for-medium-down large-3  column" >

                <div class="slide-animate" ng-if="!sidecart" ng-include="'partials/basket.html'"></div>

                <div class="panel" ng-if="sf">
                    <a href="#"><img ng-src="{{sf.context.user.profilePhotoUrl}}" /></a>
                    <hr/>
                    <h4 ng-bind="sf.context.user.fullName"></h4>
                </div>
                <!-- 
                <a class="button expand" ng-class="{'disabled': !homeonline, 'success': homeonline && syncinfo.tosync > 0 && syncinfo.errcount == 0, 'alert': homeonline && syncinfo.errcount >0 }" ng-href="#/customer?sync"> Sync <span ng-show="syncinfo.tosync > 0" >[{{syncinfo.tosync}}]</span></a>
            		-->
            </div>

            <!-- RIGHT TWO THIRDS -->
            <div class="large-9 medium-12 column">
                <div class="ngViewContainer">
                    <div  class="ng-view view-animate"></div>
                </div>
            </div>
        </div>
        
     <!--        
    </div>

</div>
-->

<script src="bower_components/foundation/js/vendor/jquery.js"></script>
<script src="bower_components/foundation/js/foundation.min.js"></script>
<script>
    $(document).foundation();
</script>

<script src="bower_components/angular/angular.js"></script>
<script src="bower_components/angular-route/angular-route.min.js"></script>
<script src="bower_components/angular-resource/angular-resource.min.js"></script>
<script src="bower_components/angular-animate/angular-animate.min.js"></script>
<script src="bower_components/angular-cookies/angular-cookies.min.js"></script>
<script src="js/module-sfdata.js"></script>
<script src="js/productsearchctrl.js"></script>
<script src="js/configure.js"></script>
<script src="js/customer.js"></script>


<script>
    /*
     * POST https://login.salesforce.com/services/oauth2/token
     * DATA: grant_type=password&client_id=3MVG99qusVZJwhskfsiYZz9vAn3iWjp4V79_irNpsQl9yNiuTCogBf9YkZH_OK9JmP_hdODiXWhX6RqC.RaH4&client_secret=
     2294924384309051352&username=khowling%40telco.dev&password=password123
    *
    */
    var _sfdccreds = {
        sf_userid: '{!$User.Id}',
        sf_host_url: 'https://eu2.salesforce.com',
        static_resource_url: './static_resources',
        sfdc_api_version: '/services/data/v30.0',
        clientId: '3MVG99qusVZJwhskfsiYZz9vAn3iWjp4V79_irNpsQl9yNiuTCogBf9YkZH_OK9JmP_hdODiXWhX6RqC.RaH4',
        session_api: '00Db0000000diWP!ARIAQCK2lv4_8p7GinHOGDC0Swvd1vPJhMUMsBkw6hPlJZ6SOpR49jc.xggwf0wFBhnTz8TVqf8m6u7AC6eZ4Gs16t1uHScc',
        refresh_api: ''
    	};


    angular.module('myApp', ['ngResource', 'ngRoute', 'ngAnimate', 'ngCookies', 'sfdata'])
    	.config(['$routeProvider', function($routeProvider){
        $routeProvider.
                when('/', {
                    templateUrl: 'partials/home.html',
             //       resolve: ensureSFDCDataServiceInitialised,
                    controller: function ($scope, SFDCData) {
                    	
                    }
                }).
                when('/search', {
                    templateUrl: 'partials/productsearch.html',
                    controller: 'searchCtrl'
                }).
                when('/configure/:id', {
                    templateUrl: 'partials/configure.html',
                    controller: 'configureCtrl'
                }).
                when('/packages', {
                    templateUrl: 'partials/packages.html'
                }).
                when('/basket', {
                    templateUrl: 'partials/basket.html'
                }).
                when('/guided', {
                    templateUrl: 'partials/guided.html',
                    controller: 'searchCtrl'
                }).
                when('/customer', {
                    templateUrl: 'partials/customer.html',
                    controller: 'custCntl'
                }).
                otherwise({
                    redirectTo: '/'
                });
    }]).filter('split', function() {
        return function(input, delimiter) {
            var delimiter = delimiter || ',';

            return input.split(delimiter);
        }
    }).filter('sfnametolabel', function() {
        return function(input) {
            try {
                return input.replace ('__c', '').replace(/_/g, ' ');
            } catch (e) {
                return 'NO VALUE*';
            }
        }
    }).run(['SFDCData', '$rootScope', '$location', '$http', '$cookies', '$cookieStore', '$route', function(SFDCData, $rootScope, $location, $http, $cookies, $cookieStore, $route) {

    	// setup sync metrics
    	SFDCData.initSyncinfo ();

    	// setup basket
    	$rootScope.resetBasket = function () {
    		console.log ('resetBasket');
    		$rootScope.selectedCustomer = null; 
    		$rootScope.selectedBasket = {total: 0.00, items: 0, product: [], payload: []};
	    	return true;
    	}
    	$rootScope.addBasket = function (product, productConfigPrice, productConfig) {
	    	$rootScope.selectedBasket.total += productConfigPrice;
	    	$rootScope.selectedBasket.items ++;
	    	$rootScope.selectedBasket.product.push({product:  product, config: productConfig, price: productConfigPrice})
	    	$rootScope.selectedBasket.payload.push({product:  product.Id, config: productConfig, price: productConfigPrice});
	    }
	    $rootScope.resetBasket();
	    
	    $rootScope.insertSFDC = function() {
	    	console.log ('insertSFDC ');
	    	  $rootScope.saveErrorStr = null;
	        SFDCData.insert("Order__c", {"Contact__c": {"_soupEntryId": $rootScope.selectedCustomer._soupEntryId, "Id": $rootScope.selectedCustomer.Id } ,"OrderMetaData__c": angular.toJson($rootScope.selectedBasket.payload)})
	        	.then(function (res) {
		        	console.log ('got ' + angular.toJson(res));
		        	if (res.id) {
		        		jQuery('#orderconf_modal').foundation('reveal', 'open');
		        		$rootScope.resetBasket();
		        	} else if (res._soupEntryId) {
		        		jQuery('#orderconf_modal').foundation('reveal', 'open');
		        		$rootScope.resetBasket();
		        	} else  { // array
		        		$rootScope.saveErrorStr = 'Didnt Save';
		        		if (res.message) {
		        			$rootScope.saveErrorStr  += ': ' + res.message;
		        		}
		        	}
	         });
	    }
	    
    		
    	$rootScope.$on("$routeChangeSuccess", function(currentRoute, previousRoute){
    		    $rootScope.sidecart = true;
    		    if ($route.current.loadedTemplateUrl !== "partials/basket.html") {
    		    	$rootScope.sidecart = false;
    		    }
    	});
    		
			console.log ('running in website, so DONT wait for cordova ready? param : ' + document.URL.split('web=')[1] );
	    if (document.URL.split('web=')[1] == "1") {
	    	SFDCData.resolveCordova(null);
	    }
	    
	   
    }]);

    
    var homeCtrl = function ($rootScope, $scope, SFDCData) {
		    var cordova_change = false,
		    		user_change = false;
		    
		    $scope.$watch('homeonline', function(val) {
		    	console.log ('homeCtrl homeonline change, cordova_change? ' + cordova_change);
		    	if (cordova_change) cordova_change = false;
		    	else {
		    		user_change = true;
		    		console.log ('homeCtrl online change BY THE USER to: ' + val);
		    		SFDCData.setOnline(val);
		    		$scope.mode = val && 'online' || 'offline';
		    	}
		    });
		
		    
		    //$rootScope.online = SFDCData.getOnline();
		    $rootScope.$watch('online', function(val) {
		    	
		    	console.log ('homeCtrl online change, user_change? ' + user_change);
		    	if (user_change) user_change = false; 
		    	else {
		    		cordova_change = true;
		    		console.log ('homeCtrl online change BY CORDOVA to: ' + val);
			    	$scope.homeonline = $rootScope.online;
			    	$scope.mode = val && 'online' || 'offline';
		    	}
		    });
	    }
	    /*
       if ($cookies.sfcontext) {
           // we are in the canvas context!
           console.log ($cookies.sfcontext);
           $rootScope.sf = angular.fromJson ($cookies.sfcontext);
           $cookieStore.remove("sfcontext");
       }

        
        try {

            $http.get('/sfsession').then (function (res) {
                $rootScope.access_token = res.data.access_token ;
                $rootScope.instanceUrl = res.data.instance_url;
            })

        //    var sr = JSON.parse('{{{signedreq}}}');
            // set instanceUrl for links to salesforce objects
        //    $rootScope.instanceUrl = sr.client.instanceUrl;
        //    $rootScope.access_token = sr.client.oauthToken;
        //    $rootScope.targetOrigin = sr.client.targetOrigin;

            // lookup the client the order is for
            var clientid = sr.context.environment.parameters.id;
            var client_url = sr.context.links.sobjectUrl + 'Contact/' + clientid + '/';
            Sfdc.canvas.client.ajax(
                    client_url,
                    {client : sr.client,
                        success : function(data){
                            // Make sure the status code is OK.
                            $rootScope.$apply(function(){
                                console.log ("response  "   + data.payload.Name);
                                $rootScope.contact = data.payload;
                            });
                        }});
        } catch (e) {
            console.log ('no Signed Request');
            $rootScope.instanceUrl = "https://eu2.salesforce.com";
        }
*/
    
</script>

</body>
</html>